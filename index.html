<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>GovCap | Material Intelligence</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

<style>
:root {
  --bg-app: #F8F9FA;
  --bg-surface: #FFFFFF;
  --primary: #1A73E8;
  --text-main: #202124;
  --text-sec: #5F6368;
  --outline: #DADCE0;
  
  --elevation-1: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
  --elevation-2: 0 4px 8px 3px rgba(60,64,67,0.15);
  
  --font-brand: 'Google Sans', sans-serif;
  --font-body: 'Roboto', sans-serif;
  
  --sidebar-width: 280px;
}

* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
body { font-family: var(--font-body); background: var(--bg-app); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }

/* LAYOUT */
.app-shell { display: flex; width: 100%; height: 100%; position: relative; }

/* SIDEBAR (Desktop Fixed, Mobile Drawer) */
.sidebar {
  width: var(--sidebar-width); background: var(--bg-surface); border-right: 1px solid var(--outline);
  display: flex; flex-direction: column; z-index: 100;
  transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
}

.sidebar-header { padding: 16px 20px; display: flex; align-items: center; justify-content: space-between; min-height: 64px; }
.brand { display: flex; align-items: center; gap: 8px; font-family: var(--font-brand); font-size: 20px; color: var(--text-sec); }
.brand span { color: var(--primary); font-weight: 700; }
.close-btn { display: none; background: none; border: none; color: var(--text-sec); cursor: pointer; }

.sidebar-content { padding: 0 16px 20px; flex: 1; overflow-y: auto; }

/* INPUTS */
.search-box {
  background: #F1F3F4; border-radius: 8px; padding: 0 12px; height: 48px;
  display: flex; align-items: center; margin-bottom: 16px;
}
.search-input { border: none; background: transparent; height: 100%; width: 100%; font-size: 16px; margin-left: 8px; color: var(--text-main); }

.section-label { font-size: 11px; font-weight: 700; color: var(--text-sec); text-transform: uppercase; margin: 16px 0 8px; }

.chip-group { display: flex; flex-wrap: wrap; gap: 8px; }
.chip {
  height: 32px; padding: 0 12px; border-radius: 16px; border: 1px solid var(--outline);
  background: #fff; font-size: 13px; font-weight: 500; color: #3C4043; cursor: pointer;
  display: flex; align-items: center; font-family: var(--font-brand);
}
.chip:active { background: #E8F0FE; border-color: var(--primary); color: var(--primary); }

.fab-btn {
  background: var(--primary); color: #fff; border: none; height: 44px; border-radius: 22px;
  width: 100%; font-family: var(--font-brand); font-weight: 500; font-size: 14px;
  margin-top: 24px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer;
  display: flex; align-items: center; justify-content: center; gap: 8px;
}

/* MAIN AREA */
.main { flex: 1; display: flex; flex-direction: column; width: 100%; overflow: hidden; position: relative; }

.top-bar {
  height: 64px; background: var(--bg-surface); border-bottom: 1px solid var(--outline);
  display: flex; align-items: center; justify-content: space-between; padding: 0 24px; flex-shrink: 0;
}
.menu-btn { display: none; background: none; border: none; color: var(--text-sec); margin-right: 16px; cursor: pointer; }

.page-info h1 { font-family: var(--font-brand); font-size: 20px; font-weight: 400; color: var(--text-main); }
.page-info div { font-size: 12px; color: var(--text-sec); display: flex; align-items: center; gap: 6px; }
.badge { background: #E8F0FE; color: var(--primary); padding: 2px 6px; border-radius: 4px; font-weight: 500; }

.content-scroll { flex: 1; overflow-y: auto; padding: 24px; -webkit-overflow-scrolling: touch; }

/* GRID SYSTEM */
.grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 20px; padding-bottom: 80px; }

/* CARDS */
.card {
  background: var(--bg-surface); border-radius: 8px; border: 1px solid var(--outline);
  box-shadow: 0 1px 2px rgba(60,64,67,0.1); display: flex; flex-direction: column; overflow: hidden;
}
.card-header { padding: 14px 20px; border-bottom: 1px solid #F1F3F4; font-family: var(--font-brand); font-size: 15px; font-weight: 500; }
.card-body { padding: 20px; flex: 1; min-width: 0;}
.table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }

/* SPANS (Desktop) */
.col-3 { grid-column: span 3; }
.col-4 { grid-column: span 4; }
.col-6 { grid-column: span 6; }
.col-8 { grid-column: span 8; }
.col-12 { grid-column: span 12; }

/* KPI STYLES */
.kpi-label { font-size: 11px; font-weight: 500; text-transform: uppercase; color: var(--text-sec); margin-bottom: 6px; letter-spacing: 0.5px; }
.kpi-val { font-family: var(--font-brand); font-size: 28px; line-height: 1; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.kpi-sub { font-size: 12px; margin-top: 6px; color: #188038; font-weight: 500; }

/* CHARTS */
.chart-wrap { height: 220px; display: flex; align-items: flex-end; gap: 6px; padding-top: 10px; }
.bar-col { flex: 1; height: 100%; display: flex; flex-direction: column; justify-content: flex-end; }
.bar { width: 100%; background: #4285F4; border-radius: 4px 4px 0 0; min-height: 4px; transition: height 0.5s; }
.bar-lbl { text-align: center; font-size: 10px; color: var(--text-sec); margin-top: 6px; }
.bar-val { text-align: center; font-size: 10px; font-weight: 700; margin-bottom: 2px; }

/* TABLES */
.data-table { width: 100%; border-collapse: collapse; min-width: 400px; table-layout: fixed;}
.data-table th { text-align: left; padding: 12px 20px; background: #fff; font-size: 11px; color: var(--text-sec); font-weight: 500; border-bottom: 1px solid var(--outline); position: sticky; top: 0; }
.data-table td { padding: 12px 20px; font-size: 13px; border-bottom: 1px solid #F1F3F4; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.text-right { text-align: right; }

/* RISK */
.risk-row { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
.risk-name { font-size: 12px; font-weight: 500; width: 90px; flex-shrink: 0; }
.risk-bar-bg { flex: 1; height: 6px; background: #F1F3F4; border-radius: 3px; overflow: hidden; }
.risk-bar { height: 100%; border-radius: 3px; }

/* BACKDROP (Mobile) */
.backdrop {
  position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 90;
  opacity: 0; pointer-events: none; transition: opacity 0.3s;
}

/* LOADER */
.loader { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 200; display: none; align-items: center; justify-content: center; flex-direction: column; }
.spinner { width: 40px; height: 40px; border: 4px solid #E8F0FE; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* --- MOBILE RESPONSIVE --- */
@media (max-width: 768px) {
  .sidebar { position: fixed; top: 0; left: 0; bottom: 0; transform: translateX(-100%); box-shadow: var(--elevation-2); }
  .sidebar.open { transform: translateX(0); }
  .backdrop.open { opacity: 1; pointer-events: auto; }
  
  .close-btn { display: block; }
  .menu-btn { display: block; }
  .top-bar { padding: 0 16px; }
  
  .content-scroll { padding: 16px; }
  .grid { display: flex; flex-direction: column; gap: 16px; }
  
  .col-3, .col-4, .col-6, .col-8, .col-12 { width: 100%; }
  
  .kpi-val { font-size: 24px; }
  .card-header { padding: 12px 16px; }
  .card-body { padding: 16px; }
  
  .risk-row { gap: 8px; }
  .risk-name { width: 80px; }
}
</style>
</head>
<body>

<div class="loader" id="loader">
  <div class="spinner"></div>
  <div style="margin-top:16px; font-family:'Google Sans'; color:#5F6368; font-weight:500;">Analyzing Data...</div>
</div>

<div class="backdrop" id="backdrop" onclick="App.toggleSidebar()"></div>

<div class="app-shell">
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="brand">
        <span class="material-icons-round">analytics</span>
        Gov<span>Cap</span>
      </div>
      <button class="close-btn" onclick="App.toggleSidebar()"><span class="material-icons-round">close</span></button>
    </div>

    <div class="sidebar-content">
      <div class="section-label">Company Search</div>
      <div class="search-box">
        <span class="material-icons-round" style="color:#5F6368;">search</span>
        <input type="text" id="searchInput" class="search-input" value="Amazon Web Services">
      </div>

      <div class="section-label">Quick Access</div>
      <div class="chip-group">
        <div class="chip" onclick="App.quickLoad('Amazon Web Services')">AWS</div>
        <div class="chip" onclick="App.quickLoad('Palantir')">Palantir</div>
        <div class="chip" onclick="App.quickLoad('Carahsoft')">Carahsoft</div>
        <div class="chip" onclick="App.quickLoad('General Dynamics')">GDIT</div>
        <div class="chip" onclick="App.quickLoad('Booz Allen Hamilton')">Booz Allen</div>
        <div class="chip" onclick="App.quickLoad('Oracle')">Oracle</div>
      </div>

      <button class="fab-btn" onclick="App.runAnalysis()">
        <span class="material-icons-round">refresh</span> Update Analysis
      </button>

      <div style="margin-top:24px; padding:12px; background:#E8F0FE; border-radius:8px; color:#1967D2; font-size:12px; line-height:1.5;">
        <strong>Strict 3-Year Filter</strong><br>
        Showing only new contracts awarded after <span id="cutoffDisplay"></span>.
      </div>
    </div>
  </aside>

  <main class="main">
    <div class="top-bar">
      <div style="display:flex; align-items:center;">
        <button class="menu-btn" onclick="App.toggleSidebar()"><span class="material-icons-round">menu</span></button>
        <div class="page-info">
          <h1 id="pageTitle">Amazon Web Services</h1>
          <div>
            <span class="material-icons-round" style="font-size:14px;">verified</span>
            USASpending.gov
            <span class="badge" style="margin-left:8px;">New Business (36mo)</span>
          </div>
        </div>
      </div>
      <button class="chip" onclick="App.exportData()">
        <span class="material-icons-round" style="font-size:16px; margin-right:4px;">download</span> Export
      </button>
    </div>

    <div class="content-scroll">
      <div class="grid">
        
        <div class="card col-3">
          <div class="card-body">
            <div class="kpi-label">Total Contract Value</div>
            <div class="kpi-val" id="kpiTCV">-</div>
            <div class="kpi-sub" style="color:#5F6368;">Strict 3-Year Sum</div>
          </div>
        </div>
        <div class="card col-3">
          <div class="card-body">
            <div class="kpi-label">Prime Revenue</div>
            <div class="kpi-val" id="kpiPrime">-</div>
            <div class="kpi-sub" id="subPrime">Direct Awards</div>
          </div>
        </div>
        <div class="card col-3">
          <div class="card-body">
            <div class="kpi-label">Active Agencies</div>
            <div class="kpi-val" id="kpiAgencies">-</div>
            <div class="kpi-sub" style="color:#5F6368;">Customer Base</div>
          </div>
        </div>
        <div class="card col-3">
          <div class="card-body">
            <div class="kpi-label">Avg. Deal Size</div>
            <div class="kpi-val" id="kpiACV">-</div>
            <div class="kpi-sub" style="color:#5F6368;">Contract Velocity</div>
          </div>
        </div>

        <div class="card col-8">
          <div class="card-header">Investment Thesis</div>
          <div class="card-body" id="thesisPanel">
            <div style="color:#9AA0A6;">Run analysis to generate thesis...</div>
          </div>
        </div>

        <div class="card col-4">
          <div class="card-header">Risk Profile</div>
          <div class="card-body" id="riskPanel">
            <div style="color:#9AA0A6;">Pending data...</div>
          </div>
        </div>

        <div class="card col-8">
          <div class="card-header">New Business Growth (Fiscal Year)</div>
          <div class="card-body">
            <div class="chart-wrap" id="chartGrowth"></div>
          </div>
        </div>

        <div class="card col-4">
          <div class="card-header">Channel Composition</div>
          <div class="card-body" id="chartChannel" style="display:flex; flex-direction:column; justify-content:center;">
          </div>
        </div>

        <div class="card col-6">
          <div class="card-header">Top Agencies (Obligated)</div>
          <div class="card-body table-responsive" style="padding:0;">
            <table class="data-table">
              <colgroup><col style="width: 50%"><col style="width: 25%"><col style="width: 25%"></colgroup>
              <thead><tr><th>Agency</th><th class="text-right">Value</th><th class="text-right">Share</th></tr></thead>
              <tbody id="tableAgencies"></tbody>
            </table>
          </div>
        </div>

        <div class="card col-6">
          <div class="card-header">Contract Vehicles</div>
          <div class="card-body table-responsive" style="padding:0;">
            <table class="data-table">
              <colgroup><col style="width: 50%"><col style="width: 25%"><col style="width: 25%"></colgroup>
              <thead><tr><th>Vehicle</th><th class="text-right">Value</th><th class="text-right">Mix</th></tr></thead>
              <tbody id="tableVehicles"></tbody>
            </table>
          </div>
        </div>

        <div class="card col-12">
          <div class="card-header">Recent Transactions</div>
          <div class="card-body table-responsive" style="padding:0;">
            <table class="data-table">
              <colgroup><col style="width: 40%"><col style="width: 20%"><col style="width: 15%"><col style="width: 15%"><col style="width: 10%"></colgroup>
              <thead><tr><th>Description</th><th>Agency</th><th>Type</th><th class="text-right">Value</th><th>Date</th></tr></thead>
              <tbody id="tableContracts"></tbody>
            </table>
          </div>
        </div>

      </div>
    </div>
  </main>
</div>

<script>
const App = {
  target: '',
  
  init() {
    // Set Date in UI
    const d = new Date();
    d.setFullYear(d.getFullYear() - 3);
    document.getElementById('cutoffDisplay').innerText = d.toLocaleDateString();

    document.getElementById('searchInput').addEventListener('keypress', (e) => {
      if(e.key === 'Enter') this.runAnalysis();
    });
    
    // Auto-run
    this.runAnalysis();
  },

  toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('open');
    document.getElementById('backdrop').classList.toggle('open');
  },

  quickLoad(name) {
    document.getElementById('searchInput').value = name;
    this.runAnalysis();
    // Close sidebar on mobile selection
    if(window.innerWidth <= 768) this.toggleSidebar();
  },

  async runAnalysis() {
    this.target = document.getElementById('searchInput').value.trim();
    if(!this.target) return;
    
    document.getElementById('pageTitle').innerText = this.target;
    document.getElementById('loader').style.display = 'flex';

    try {
      // Parallel fetch
      const [prime, subs] = await Promise.all([
        this.fetchPrime(this.target),
        this.fetchSubs(this.target)
      ]);
      this.processData(prime, subs);
    } catch(e) {
      console.error(e);
      alert('Connection Error. Please check company name.');
    } finally {
      document.getElementById('loader').style.display = 'none';
    }
  },

  async fetchPrime(keyword) {
    const end = new Date().toISOString().split('T')[0];
    const startObj = new Date(); startObj.setFullYear(new Date().getFullYear() - 3);
    const start = startObj.toISOString().split('T')[0];

    // API Call
    const res = await fetch('https://api.usaspending.gov/api/v2/search/spending_by_award/', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        filters: {
          keywords: [keyword],
          time_period: [{start_date: start, end_date: end}],
          award_type_codes: ['A','B','C','D']
        },
        fields: ['Award ID', 'Recipient Name', 'Award Amount', 'Awarding Agency', 'Start Date', 'Description'],
        limit: 100, sort: 'Award Amount', order: 'desc'
      })
    });
    return (await res.json()).results || [];
  },

  async fetchSubs(keyword) {
    const end = new Date().toISOString().split('T')[0];
    const startObj = new Date(); startObj.setFullYear(new Date().getFullYear() - 3);
    
    try {
      const res = await fetch('https://api.usaspending.gov/api/v2/search/spending_by_award/', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          filters: { keywords: [keyword], time_period: [{start_date: startObj.toISOString().split('T')[0], end_date: end}], award_type_codes: ['A','B','C','D'] },
          fields: ['Recipient Name', 'Award Amount'],
          subawards: true, limit: 50
        })
      });
      return (await res.json()).results || [];
    } catch(e) { return []; }
  },

  processData(prime, subs) {
    const cleanTarget = this.target.toLowerCase().replace(/[,.]/g, '');
    const currentFY = this.getFY(new Date());
    
    // STRICT CLIENT-SIDE DATE FILTER
    const cutoffDate = new Date();
    cutoffDate.setFullYear(cutoffDate.getFullYear() - 3);

    let s = { total: 0, direct: 0, count: 0, agencies: {}, years: {}, partners: {}, vehicles: {}, contracts: [] };

    prime.forEach(r => {
      // 1. Strict Date Check
      const startDt = new Date(r['Start Date']);
      if (startDt < cutoffDate) return;

      const amt = r['Award Amount'] || 0;
      if (amt <= 0) return;
      
      const fy = this.getFY(startDt);
      s.years[fy] = (s.years[fy] || 0) + amt;

      s.total += amt;
      s.count++;
      s.contracts.push(r);
      s.agencies[r['Awarding Agency']] = (s.agencies[r['Awarding Agency']] || 0) + amt;

      if (r['Recipient Name'].toLowerCase().includes(cleanTarget)) {
        s.direct += amt;
      } else {
        s.partners[r['Recipient Name']] = (s.partners[r['Recipient Name']] || 0) + amt;
      }

      let v = 'Open Market';
      const id = r['Award ID'];
      if(id.startsWith('GS')) v = 'GSA Schedule';
      else if(id.includes('SEWP')) v = 'NASA SEWP';
      else if(id.startsWith('47Q')) v = 'GSA OASIS';
      else if(id.startsWith('FA')) v = 'DoD IDIQ';
      else if(id.startsWith('NNG')) v = 'NASA SEWP';
      
      s.vehicles[v] = (s.vehicles[v] || 0) + amt;
    });

    subs.forEach(r => {
      s.partners[r['Recipient Name']] = (s.partners[r['Recipient Name']] || 0) + (r['Award Amount'] || 0);
    });

    this.renderAll(s, currentFY);
  },

  renderAll(s, currentFY) {
    // KPIS
    document.getElementById('kpiTCV').innerText = this.fmt(s.total);
    
    const primePct = s.total > 0 ? (s.direct/s.total)*100 : 0;
    document.getElementById('kpiPrime').innerText = primePct.toFixed(0) + '%';
    // FIX applied here: added id="subPrime" to HTML above so this executes perfectly
    document.getElementById('subPrime').style.color = primePct > 50 ? '#188038' : '#EA4335';
    document.getElementById('subPrime').innerText = primePct > 50 ? 'Strong Prime' : 'Channel Heavy';
    
    document.getElementById('kpiAgencies').innerText = Object.keys(s.agencies).length;
    document.getElementById('kpiACV').innerText = this.fmtShort(s.total/s.count);

    // THESIS & RISK
    this.renderThesis(s, primePct);
    this.renderRisk(s, primePct);

    // GROWTH CHART (Exclude Partial)
    const years = Object.keys(s.years).sort();
    const fullYears = years.filter(y => parseInt(y) < currentFY);
    const maxVal = Math.max(...Object.values(s.years)) || 1;
    
    document.getElementById('chartGrowth').innerHTML = fullYears.length ? fullYears.map(y => {
      const h = (s.years[y]/maxVal)*100;
      return `<div class="bar-col"><div class="bar-val">${this.fmtShort(s.years[y])}</div><div class="bar" style="height:${h}%"></div><div class="bar-lbl">FY${y}</div></div>`;
    }).join('') : '<div style="width:100%; text-align:center; color:#5F6368; align-self:center;">Insufficient Data</div>';

    // CHANNEL CHART
    const partners = Object.entries(s.partners).sort((a,b)=>b[1]-a[1]).slice(0,3);
    let chanHTML = '';
    const renderChan = (lbl, val, col) => {
      const p = s.total > 0 ? (val/s.total)*100 : 0;
      return `<div style="margin-bottom:8px"><div style="display:flex; justify-content:space-between; font-size:12px; color:#5F6368; margin-bottom:2px;"><span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:180px;" title="${lbl}">${lbl}</span><span>${p.toFixed(0)}%</span></div><div style="height:6px; background:#F1F3F4; border-radius:3px;"><div style="width:${p}%; height:100%; background:${col}; border-radius:3px;"></div></div></div>`;
    };
    chanHTML += renderChan('Direct Prime', s.direct, '#34A853');
    partners.forEach(p => chanHTML += renderChan(p[0], p[1], '#4285F4'));
    document.getElementById('chartChannel').innerHTML = chanHTML;

    // TABLES
    this.renderTable('tableAgencies', s.agencies, s.total);
    this.renderTable('tableVehicles', s.vehicles, s.total);
    this.renderContracts(s.contracts);
  },

  renderThesis(s, primePct) {
    const topAgency = Object.entries(s.agencies).sort((a,b)=>b[1]-a[1])[0];
    const topShare = topAgency ? ((topAgency[1]/s.total)*100).toFixed(0) : 0;
    
    document.getElementById('thesisPanel').innerHTML = `
      <div class="thesis-section">
        <div class="thesis-head"><span class="material-icons-round" style="font-size:18px;">trending_up</span> Growth</div>
        <div class="thesis-text">Target generated <strong>${this.fmtShort(s.total)}</strong> in new awards (3yr). Operating as <strong>${primePct.toFixed(0)}% Prime</strong>.</div>
      </div>
      <div class="thesis-section">
        <div class="thesis-head"><span class="material-icons-round" style="font-size:18px;">shield</span> Moat</div>
        <div class="thesis-text">Top customer <strong>${topAgency ? topAgency[0] : 'N/A'}</strong> holds <strong>${topShare}%</strong> of bookings.</div>
      </div>
    `;
  },

  renderRisk(s, primePct) {
    const topAgency = Object.entries(s.agencies).sort((a,b)=>b[1]-a[1])[0];
    const topShare = topAgency ? ((topAgency[1]/s.total)*100) : 0;
    
    const renderRiskRow = (lbl, val, bad) => {
      const col = val > bad ? '#EA4335' : '#34A853';
      return `<div class="risk-row"><div class="risk-name">${lbl}</div><div class="risk-bar-bg"><div class="risk-bar" style="width:${val}%; background:${col}"></div></div><div class="risk-val">${val.toFixed(0)}%</div></div>`;
    };
    
    document.getElementById('riskPanel').innerHTML = `
      ${renderRiskRow('Concentration', topShare, 40)}
      ${renderRiskRow('Indirect', 100-primePct, 50)}
    `;
  },

  renderTable(id, data, total) {
    const rows = Object.entries(data).sort((a,b)=>b[1]-a[1]).slice(0,5);
    document.getElementById(id).innerHTML = rows.map(([n,v]) => `
      <tr>
        <td title="${n}">${n}</td>
        <td class="text-right" style="font-family:'Roboto Mono'">${this.fmtShort(v)}</td>
        <td class="text-right" style="font-family:'Roboto Mono'">${((v/total)*100).toFixed(1)}%</td>
      </tr>`).join('');
  },

  renderContracts(contracts) {
    const rows = contracts.sort((a,b) => new Date(b['Start Date']) - new Date(a['Start Date'])).slice(0,25);
    const targetKey = this.target.toLowerCase().replace(/[,.]/g, '');
    
    document.getElementById('tableContracts').innerHTML = rows.map(c => {
       const isPrime = (c['Recipient Name']||'').toLowerCase().includes(targetKey);
       return `
         <tr>
           <td title="${c['Description']}">${(c['Description']||'').substring(0,60)}</td>
           <td title="${c['Awarding Agency']}">${c['Awarding Agency']}</td>
           <td><span class="badge ${isPrime?'prime':'sub'}">${isPrime?'Prime':'Partner'}</span></td>
           <td class="text-right"><strong style="font-family:'Roboto Mono'; font-weight:500;">${this.fmtShort(c['Award Amount'])}</strong></td>
           <td style="font-family:'Roboto Mono'">${c['Start Date']}</td>
         </tr>`;
    }).join('');
  },

  exportData() {
    // Generate actual CSV string from the active target's contracts
    if (!this.data || !this.data.contracts.length) {
      alert("No data available to export.");
      return;
    }
    
    const contracts = this.data.contracts;
    
    // Create headers
    const headers = ["Description", "Awarding Agency", "Recipient Name", "Award Amount", "Start Date", "Award ID", "Type"];
    
    // Map rows to CSV format (handling commas in description strings)
    const rows = contracts.map(c => {
      const desc = `"${(c['Description'] || '').replace(/"/g, '""')}"`;
      const agency = `"${c['Awarding Agency'] || ''}"`;
      const rec = `"${c['Recipient Name'] || ''}"`;
      const amt = c['Award Amount'] || 0;
      const date = c['Start Date'] || '';
      const id = c['Award ID'] || '';
      const isPrime = (c['Recipient Name']||'').toLowerCase().includes(this.target.toLowerCase().replace(/[,.]/g, '')) ? 'Prime' : 'Sub/Partner';
      
      return [desc, agency, rec, amt, date, id, isPrime].join(",");
    });
    
    // Combine and trigger download
    const csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + rows.join("\n");
    const encodedUri = encodeURI(csvContent);
    
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `GovCap_${this.target.replace(/\\s+/g, '_')}_Extract.csv`);
    document.body.appendChild(link); // Required for FF
    
    link.click(); 
    document.body.removeChild(link);
  },

  getFY(d) { return d.getMonth() >= 9 ? d.getFullYear() + 1 : d.getFullYear(); },
  fmt(n) { return new Intl.NumberFormat('en-US', {style:'currency', currency:'USD', maximumFractionDigits:0}).format(n); },
  fmtShort(n) {
    if(n>=1e9) return '$'+(n/1e9).toFixed(1)+'B';
    if(n>=1e6) return '$'+(n/1e6).toFixed(1)+'M';
    if(n>=1e3) return '$'+(n/1e3).toFixed(0)+'K';
    return '$'+n.toFixed(0);
  }
};

App.init();
</script>
</body>
</html>